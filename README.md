# Loguru Feishu Handler

åŸºäº [loguru](https://github.com/Delgan/loguru) çš„é£ä¹¦æ¶ˆæ¯æ¨é€å¤„ç†å™¨ï¼Œé€šè¿‡é£ä¹¦æœºå™¨äºº webhook å°†æ—¥å¿—æ¶ˆæ¯æ¨é€åˆ°é£ä¹¦ç¾¤èŠã€‚

## ç‰¹ç‚¹

- ğŸš€ **ç®€å•æ˜“ç”¨** - ä¸€è¡Œä»£ç å³å¯æ¥å…¥é£ä¹¦æ—¥å¿—æ¨é€
- ğŸ”’ **ç¼“å­˜æœºåˆ¶** - æ”¯æŒç›¸åŒæ¶ˆæ¯ç¼“å­˜ï¼Œé¿å…é‡å¤å‘é€
- ğŸ¨ **æ ¼å¼çµæ´»** - æ”¯æŒç®€åŒ–å’Œè¯¦ç»†ä¸¤ç§æ¶ˆæ¯æ ¼å¼
- ğŸ”§ **å­—æ®µè¿‡æ»¤** - å¯é…ç½®è¿‡æ»¤ä¸éœ€è¦çš„æ—¥å¿—å­—æ®µ
- âš¡ **å¼‚æ­¥å‘é€** - å¤šçº¿ç¨‹å‘é€ï¼Œä¸é˜»å¡ä¸»ç¨‹åº
- ğŸ›¡ï¸ **å¼‚å¸¸å®‰å…¨** - å‘é€å¤±è´¥ä¸å½±å“ä¸»ç¨‹åºè¿è¡Œ

## å®‰è£…

```bash
pip install loguru-feishu-handler
```

## å¿«é€Ÿå¼€å§‹

### 1. åˆ›å»ºé£ä¹¦æœºå™¨äºº

1. åœ¨é£ä¹¦ç¾¤èŠä¸­ï¼Œç‚¹å‡»ç¾¤è®¾ç½®
2. é€‰æ‹©"æœºå™¨äºº" -> "æ·»åŠ æœºå™¨äºº" -> "è‡ªå®šä¹‰æœºå™¨äºº"
3. è®¾ç½®æœºå™¨äººåç§°å’Œæè¿°
4. å¤åˆ¶ç”Ÿæˆçš„ Webhook åœ°å€
5. ï¼ˆå¯é€‰ï¼‰è®¾ç½®å…³é”®è¯è§¦å‘

### 2. åŸºç¡€ä½¿ç”¨

```python
from loguru import logger
from loguru_feishu_handler import add_feishu_sink

# æ·»åŠ é£ä¹¦ sink
sink_id = add_feishu_sink(
    webhook_url="https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxx",
    keyword="ç³»ç»Ÿå‘Šè­¦",  # é£ä¹¦æœºå™¨äººå…³é”®è¯
    level="ERROR"       # åªå‘é€ ERROR çº§åˆ«ä»¥ä¸Šçš„æ—¥å¿—
)

# å‘é€æ—¥å¿—
logger.error("è¿™æ˜¯ä¸€æ¡é”™è¯¯æ—¥å¿—")
logger.critical("ç³»ç»Ÿå‘ç”Ÿä¸¥é‡é”™è¯¯ï¼")

# å¸¦å¼‚å¸¸ä¿¡æ¯çš„æ—¥å¿—
try:
    1 / 0
except Exception as e:
    logger.exception("å‘ç”Ÿäº†é™¤é›¶é”™è¯¯")
```

### 3. é«˜çº§é…ç½®

```python
from loguru import logger
from loguru_feishu_handler import LoguruFeishuSink

# åˆ›å»ºè‡ªå®šä¹‰ sink
sink = LoguruFeishuSink(
    webhook_url="https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxx",
    keyword="ç³»ç»Ÿç›‘æ§",
    cache_time=300,  # 5åˆ†é’Ÿå†…ç›¸åŒæ¶ˆæ¯ä¸é‡å¤å‘é€
    filter_keys=["process", "thread"],  # è¿‡æ»¤æ‰è¿›ç¨‹å’Œçº¿ç¨‹ä¿¡æ¯
    simple_log_levelno=20,  # INFOçº§åˆ«ä»¥ä¸‹ä½¿ç”¨ç®€åŒ–æ ¼å¼
    simple_format=True,     # å¯ç”¨ç®€åŒ–æ ¼å¼
    timeout=15             # è¯·æ±‚è¶…æ—¶æ—¶é—´
)

# æ·»åŠ åˆ° logger
sink_id = logger.add(sink, level="INFO")

# ä½¿ç”¨ç¤ºä¾‹
logger.info("è¿™æ˜¯ä¸€æ¡ä¿¡æ¯æ—¥å¿—")  # ç®€åŒ–æ ¼å¼
logger.error("è¿™æ˜¯ä¸€æ¡é”™è¯¯æ—¥å¿—")  # è¯¦ç»†æ ¼å¼
```

### 4. æ¶ˆæ¯æ ¼å¼ç¤ºä¾‹

**ç®€åŒ–æ ¼å¼** (çº§åˆ«ä½äº WARNING):
```
ğŸ• 2024-01-15 10:30:25
ğŸ“Š INFO
ğŸ“ åº”ç”¨å¯åŠ¨æˆåŠŸ
```

**è¯¦ç»†æ ¼å¼** (çº§åˆ« WARNING åŠä»¥ä¸Š):
```
ğŸ• æ—¶é—´: 2024-01-15 10:30:25
ğŸ“Š çº§åˆ«: ERROR
ğŸ“ æ–‡ä»¶: /app/main.py:25
ğŸ”§ å‡½æ•°: process_data
ğŸ“ æ¶ˆæ¯: æ•°æ®å¤„ç†å¤±è´¥
âŒ å¼‚å¸¸ç±»å‹: ValueError
ğŸ’¬ å¼‚å¸¸ä¿¡æ¯: æ— æ•ˆçš„æ•°æ®æ ¼å¼
ğŸ” å †æ ˆä¿¡æ¯:
```
ValueError: æ— æ•ˆçš„æ•°æ®æ ¼å¼
  File "/app/main.py", line 25, in process_data
    return parse_data(raw_data)
```
```

## API å‚è€ƒ

### add_feishu_sink()

ä¾¿æ·å‡½æ•°ï¼Œå¿«é€Ÿæ·»åŠ é£ä¹¦ sinkã€‚

**å‚æ•°:**
- `webhook_url` (str): é£ä¹¦æœºå™¨äºº webhook åœ°å€
- `keyword` (str, optional): æœºå™¨äººè§¦å‘å…³é”®è¯
- `level` (str, optional): æ—¥å¿—çº§åˆ«ï¼Œé»˜è®¤ "INFO"
- `cache_time` (int, optional): ç¼“å­˜æ—¶é—´(ç§’)ï¼Œé»˜è®¤ 60
- `filter_keys` (List[str], optional): éœ€è¦è¿‡æ»¤çš„å­—æ®µåˆ—è¡¨
- `simple_log_levelno` (int, optional): ç®€åŒ–æ ¼å¼é˜ˆå€¼ï¼Œé»˜è®¤ 30 (WARNING)
- `simple_format` (bool, optional): æ˜¯å¦å¯ç”¨ç®€åŒ–æ ¼å¼ï¼Œé»˜è®¤ True
- `**kwargs`: ä¼ é€’ç»™ `logger.add()` çš„å…¶ä»–å‚æ•°

**è¿”å›:**
- `int`: sink IDï¼Œå¯ç”¨äºç§»é™¤ sink

### LoguruFeishuSink

é£ä¹¦ Sink ç±»ï¼Œæä¾›æ›´å¤šè‡ªå®šä¹‰é€‰é¡¹ã€‚

**æ–¹æ³•:**
- `__init__(webhook_url, ...)`: åˆå§‹åŒ– sink
- `__call__(message)`: å¤„ç†æ—¥å¿—æ¶ˆæ¯ï¼ˆloguru è‡ªåŠ¨è°ƒç”¨ï¼‰

## æ³¨æ„äº‹é¡¹

1. **ç½‘ç»œè¦æ±‚**: éœ€è¦èƒ½å¤Ÿè®¿é—®é£ä¹¦ API
2. **æ¶ˆæ¯é™åˆ¶**: å•æ¡æ¶ˆæ¯ä¸è¶…è¿‡ 30KB
3. **é¢‘ç‡é™åˆ¶**: å»ºè®®è®¾ç½®åˆé€‚çš„ç¼“å­˜æ—¶é—´ï¼Œé¿å…é¢‘ç¹å‘é€
4. **å¼‚å¸¸å¤„ç†**: å‘é€å¤±è´¥ä¼šæ‰“å°é”™è¯¯ä¿¡æ¯ï¼Œä½†ä¸å½±å“ä¸»ç¨‹åº

## æ›´æ–°æ—¥å¿—

### v1.0.0
- åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- æ”¯æŒåŸºç¡€çš„æ—¥å¿—æ¶ˆæ¯æ¨é€
- æ”¯æŒç¼“å­˜æœºåˆ¶
- æ”¯æŒç®€åŒ–å’Œè¯¦ç»†æ ¼å¼
- æ”¯æŒå­—æ®µè¿‡æ»¤

## è®¸å¯è¯

Apache License 2.0 